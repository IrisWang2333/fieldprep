# ğŸ”’ Multi-BFS + Regroup Bundle Version

## æ¦‚è¿°

`bundle_hard_constraint.py` åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„ bundling ç®—æ³•ï¼š

1. **Greedy (5 æ­¥, æ— çº¦æŸ)** - å¯¹åº”æ ‡å‡† `bundle.py`
2. **Multi-BFS + Regroup (9 æ­¥, ç¡¬çº¦æŸ + é‡ç»„)** - æ–°ç‰ˆæœ¬ï¼Œç”¨äºé˜²æ­¢äº§ç”Ÿæç«¯å¤§çš„ bundleï¼ŒåŒæ—¶ä¿è¯è·¯çº¿è¿ç»­æ€§å’Œæœ€å¤§åŒ–æ•°æ®åˆ©ç”¨ç‡

## é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨æ ‡å‡† `bundle.py` çš„ Greedy ç®—æ³•æ—¶ï¼Œè™½ç„¶èƒ½åˆå¹¶å¤§éƒ¨åˆ† tiny bundlesï¼Œä½†ä¼šäº§ç”Ÿæç«¯ outliersï¼š

```
Greedy ç‰ˆæœ¬ (5 æ­¥, æ— çº¦æŸ):
- Target: 60 addresses
- Mean: 99.1
- Median: 95.0
- Max: 700+ addresses  â† ğŸ˜± æç«¯å€¼ï¼
- CV: 0.42
```

## Multi-BFS + Regroup è§£å†³æ–¹æ¡ˆ

Multi-BFS + Regroup ç‰ˆæœ¬é€šè¿‡**å››å±‚æœºåˆ¶**æ§åˆ¶ bundle å¤§å°å¹¶æœ€å¤§åŒ–æ•°æ®åˆ©ç”¨ç‡ï¼š

### 1. ğŸ”’ Merge ç¡¬çº¦æŸ (1.2x = 72 addresses)

åœ¨åˆå¹¶ tiny bundles æ—¶ï¼ˆStep 6, 8ï¼‰æ£€æŸ¥å¤§å°é™åˆ¶ï¼š

```python
# å¦‚æœåˆå¹¶ä¼šå¯¼è‡´æ¥æ”¶ bundle è¶…è¿‡ target * hard_max_multiplier
# åˆ™æ‹’ç»åˆå¹¶ï¼Œä¿ç•™ tiny bundle
if current_size + tiny_size > hard_max:
    rejected_count += 1
    continue  # ä¸åˆå¹¶
```

### 2. âœ‚ï¸ Split é˜ˆå€¼ (1.0x = 60 addresses + å‰©ä½™æ£€æŸ¥)

è‡ªåŠ¨æ‹†åˆ†è¶…è¿‡ç›®æ ‡çš„ bundlesï¼Œå¸¦æ™ºèƒ½å‰©ä½™æ£€æŸ¥ï¼š

```python
# è¶…è¿‡ 1.0x target (60) çš„ bundle ä¼šè¢«æ‹†åˆ†
# ä½¿ç”¨ BFS åˆ‡å‰²ï¼Œä¿è¯è¿é€šæ€§
# ğŸ”’ å«å‰©ä½™æ£€æŸ¥ï¼šé¿å…äº§ç”Ÿ < 40 çš„ç¢ç‰‡
if bundle_size > target:
    split_bundle_with_remainder_check()
```

### 3. ğŸ”— Connected Mergeï¼ˆä¿æŒè¿é€šæ€§ï¼Œæ— çº¦æŸï¼‰

Step 3 ä½¿ç”¨åŸºäºè¿é€šæ€§çš„æ™ºèƒ½åˆå¹¶ï¼Œ**æ— å¤§å°çº¦æŸ**ï¼š

```python
# åªåˆå¹¶åˆ°æœ‰ endpoint å…±äº«çš„ bundles
# ä¼˜å…ˆé€‰æ‹©æœ€å°çš„å€™é€‰
# âŒ æ— å¤§å°çº¦æŸï¼ˆå…è®¸åˆå¹¶åˆ°å¤§ bundleï¼‰
if tiny_bundle shares endpoint with neighbor:
    merge_to_smallest_neighbor()  # æ— çº¦æŸ
```

### 4. ğŸ”„ å¾ªç¯é‡ç»„ï¼ˆStep 9ï¼Œæœ€å¤§åŒ–å¯ç”¨æ•°æ®ï¼‰

è‡ªåŠ¨é‡ç»„ä¸åˆæ ¼çš„ bundlesï¼Œæœ€å¤§åŒ–ç¬¦åˆèŒƒå›´è¦æ±‚çš„ bundles æ•°é‡ï¼š

```python
# å¾ªç¯é‡ç»„ < 48 æˆ– > 72 çš„ bundles
while iteration < 5:
    # 1. æ‰¾å‡ºä¸åˆæ ¼çš„ bundles
    # 2. æå–æ‰€æœ‰ segments
    # 3. ç”¨è´ªå©ª BFS é‡æ–°ç»„åˆ (ç›®æ ‡ 60)
    # 4. åªä¿ç•™ç¬¦åˆ [48, 72] çš„ bundles
    # 5. æ£€æŸ¥æ˜¯å¦æœ‰æ”¹è¿›
```

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: åœ¨ Python è„šæœ¬ä¸­ä½¿ç”¨

```python
from sd311_fieldprep.bundle_hard_constraint import _build_connected_bundles_multibfs

bundled = _build_connected_bundles_multibfs(
    segs_m,
    seg_id_col=seg_id,
    target_addrs=60,
    join_tol_m=15.0,
    seed=42,
    min_bundle_sfh=40,
    hard_max_multiplier=1.2  # â† æœ€å¤§ 72 addresses (60 * 1.2)
)
```

### æ–¹æ³• 2: è¿è¡Œå¯¹æ¯”æµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
cd /Users/iris/Dropbox/sandiego code/code/fieldprep
python tests/quick_comparison_hard_constraint.py
```

è¿™ä¸ªè„šæœ¬ä¼šå¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬ï¼š
1. **Greedy (5 æ­¥, æ— çº¦æŸ)** - æ ‡å‡† bundle.py
2. **Multi-BFS + Regroup (9 æ­¥, ç¡¬çº¦æŸ + é‡ç»„)** - ç¡¬çº¦æŸç‰ˆæœ¬

ç”Ÿæˆè¾“å‡ºï¼š
- `bundles_multibfs_regroup.parquet` - æ•°æ®æ–‡ä»¶
- `bundles_multibfs_regroup_map.html` - åœ°å›¾
- `comparison_greedy_vs_multibfs_regroup.png` - å¯¹æ¯”å›¾

### æ–¹æ³• 3: åˆ†æç°æœ‰ç»“æœ

#### å¿«é€Ÿåˆ†æï¼ˆä¸€é”®è¿è¡Œï¼‰

```bash
python tests/quick_analyze_hard_constraint.py
```

åœ¨ VS Code ä¸­ï¼šç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼Œç‚¹å‡»å³ä¸Šè§’è¿è¡ŒæŒ‰é’® â–¶ï¸

è¾“å‡ºï¼š
- æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´åˆ†ææŠ¥å‘Š
- `bundle_analysis_multibfs_regroup.png` - åˆ†æå›¾

### æ–¹æ³• 4: è¿‡æ»¤åˆ°åˆæ ¼èŒƒå›´ï¼ˆå¯é€‰ï¼‰

```bash
python tests/quick_filter_bundles.py
```

åŠŸèƒ½ï¼š
- è¿‡æ»¤æ‰ < 48 æˆ– > 72 addresses çš„ bundles
- ç”Ÿæˆ `bundles_multibfs_regroup_filtered.parquet`
- ç”Ÿæˆä¿ç•™çš„å’Œç­›æ‰çš„åœ°å›¾
- æŠ¥å‘Šç©ºé—´ä»£è¡¨æ€§åˆ†æ

## å®Œæ•´æ‰§è¡Œæµç¨‹ï¼ˆ9 æ­¥ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1/9: å‡†å¤‡é˜¶æ®µ                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ„å»ºé‚»æ¥å›¾ (_build_segment_neighbor_graph)                    â”‚
â”‚ â€¢ è¯†åˆ«è¿é€šåˆ†é‡ (_components_from_neighbors)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2/9: åˆå§‹ç”Ÿæˆ Bundles (Multi-BFS Balanced)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Multi-source BFS å¹³è¡¡å¢é•¿                                      â”‚
â”‚ â€¢ ç›®æ ‡ï¼šæ¯ä¸ª bundle â‰ˆ 60 addresses                              â”‚
â”‚ â€¢ ç»“æœï¼š~1800 bundles                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3/9: åˆå¹¶å°æŸ (è¿é€šæ€§åˆå¹¶, âŒ æ— çº¦æŸ, ä¼˜å…ˆæœ€å°)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _merge_tiny_bundles_connected                                  â”‚
â”‚ â€¢ âŒ æ— å¤§å°çº¦æŸï¼ˆå…è®¸åˆå¹¶åˆ°å¤§ bundleï¼‰                           â”‚
â”‚ â€¢ ğŸ”— åªåˆå¹¶åˆ°æœ‰ endpoint å…±äº«çš„ bundles                          â”‚
â”‚ â€¢ ğŸ“ ä¼˜å…ˆé€‰æ‹©æœ€å°çš„å€™é€‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4/9: Sweepï¼ˆé™„åŠ æ®‹ç•™è·¯æ®µï¼Œè½¯çº¦æŸ 1.1xï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _sweep_attach_residuals                                        â”‚
â”‚ â€¢ è½¯çº¦æŸï¼šä¼˜å…ˆ â‰¤ 66 addresses (1.1x)                            â”‚
â”‚ â€¢ Fallback å…è®¸åˆ°æ›´å¤§ï¼Œåªé™„åŠ åˆ°æœ‰ endpoint å…±äº«çš„ bundles       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5/9: æ‹†åˆ†è¶…å¤§æŸ (> 60 addresses, å«å‰©ä½™æ£€æŸ¥) â† ğŸ†•          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _split_oversized_bundles                                       â”‚
â”‚ â€¢ Split threshold: 60 addresses (1.0x target)                    â”‚
â”‚ â€¢ BFS åˆ‡å‰²ï¼Œä¿è¯è¿é€šæ€§                                           â”‚
â”‚ â€¢ âœ… å‰©ä½™æ£€æŸ¥ï¼šé¿å…äº§ç”Ÿ < 40 çš„ç¢ç‰‡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6/9: åˆå¹¶å°æŸ (è¿é€šæ€§ + ğŸ”’ ç¡¬çº¦æŸ 1.2x)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _merge_tiny_bundles_connected (hard_max = 72)                  â”‚
â”‚ â€¢ æ‹’ç»ä¼šè¶…è¿‡ 72 addresses çš„åˆå¹¶                                 â”‚
â”‚ â€¢ åªåˆå¹¶åˆ°æœ‰ endpoint å…±äº«çš„ bundles                             â”‚
â”‚ â€¢ æ¸…ç† split äº§ç”Ÿçš„ç¢ç‰‡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7/9: å¼ºåˆ¶è·¯çº¿è¿ç»­æ€§ï¼ˆæœ€ç»ˆæ£€æŸ¥ï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _enforce_endpoint_contiguity                                   â”‚
â”‚ â€¢ æ‹†åˆ†ä¸è¿ç»­çš„ bundles                                           â”‚
â”‚ â€¢ ä¿è¯æ‰€æœ‰ bundle éƒ½æ˜¯è·¯çº¿è¿ç»­çš„                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8/9: æœ€ç»ˆæ¸…ç† (è¿é€šæ€§ + ğŸ”’ ç¡¬çº¦æŸ 1.2x)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _merge_tiny_bundles_connected (hard_max = 72)                  â”‚
â”‚ â€¢ æœ€åä¸€æ¬¡åˆå¹¶æœºä¼š                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 9/9: å¾ªç¯é‡ç»„ä¸åˆæ ¼ bundles ([48, 72]) â† ğŸ†• æ–°å¢ï¼          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ _regroup_invalid_bundles                                       â”‚
â”‚ â€¢ æ‰¾å‡º < 48 æˆ– > 72 addresses çš„ bundles                         â”‚
â”‚ â€¢ æ‰“æ•£å¹¶ç”¨è´ªå©ª BFS é‡æ–°ç»„åˆï¼ˆç›®æ ‡ 60ï¼‰                           â”‚
â”‚ â€¢ åªä¿ç•™ç¬¦åˆ [48, 72] èŒƒå›´çš„ bundles                             â”‚
â”‚ â€¢ æœ€å¤šè¿­ä»£ 5 æ¬¡ï¼Œç›´åˆ°æ— æ”¹è¿›æˆ–å…¨éƒ¨åˆæ ¼                            â”‚
â”‚ â€¢ âœ… æœ€å¤§åŒ–å¯ç”¨ bundles æ•°é‡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                       âœ… å®Œæˆï¼
```

## å‚æ•°è¯´æ˜

### `target_addrs`

ç›®æ ‡åœ°å€æ•°ï¼š

| å€¼ | ç”¨é€” |
|---|---|
| `60` | DH session (å½“å‰æ¨è) âœ… |
| `120` | D2DS session |

### `hard_max_multiplier`

æ§åˆ¶æœ€å¤§ bundle å¤§å°çš„å€æ•°ï¼ˆç”¨äº Step 6, 8 ç¡¬çº¦æŸï¼‰ï¼š

| å€¼ | å«ä¹‰ | ç¤ºä¾‹ (target=60) |
|---|---|---|
| `1.0` | 100% of target (å¾ˆä¸¥æ ¼) | Max = 60 addresses |
| `1.2` | 120% of target (æ¨è) âœ… | Max = 72 addresses |
| `1.5` | 150% of target | Max = 90 addresses |
| `None` | ç¦ç”¨ç¡¬çº¦æŸ | æ— é™åˆ¶ (è½¯çº¦æŸ) |

**æ¨èå€¼**: 1.2 (ä¸¥æ ¼æ§åˆ¶ï¼Œé€‚åˆç”Ÿäº§éƒ¨ç½²)

**æ³¨æ„**:
- **Step 3**: è¿é€šæ€§åˆå¹¶ï¼ŒâŒ æ— çº¦æŸ
- **Step 4**: Sweep è½¯çº¦æŸ 1.1x (66 addresses)
- **Step 5**: Split é˜ˆå€¼å›ºå®š 1.0x (60 addresses)
- **Step 6, 8**: Merge ç¡¬çº¦æŸ 1.2x (72 addresses)
- **Step 9**: Regroup èŒƒå›´ [0.8x, 1.2x] = [48, 72]

### `min_bundle_sfh`

æœ€å° bundle å¤§å°é˜ˆå€¼ï¼š

| å€¼ | è¡Œä¸º |
|---|---|
| `None` | ä¸åˆå¹¶ tiny bundles |
| `40` | åˆå¹¶ < 40 addresses çš„ bundles (æ¨è) âœ… |
| `60` | æ›´æ¿€è¿›çš„åˆå¹¶ |

## çº¦æŸå±‚çº§è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤           â”‚ å‡½æ•°                  â”‚ çº¦æŸç±»å‹ â”‚ é˜ˆå€¼            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3         â”‚ _merge_tiny_bundles_  â”‚ âŒ None  â”‚ æ— çº¦æŸ          â”‚
â”‚ (è¿é€šæ€§åˆå¹¶)   â”‚ connected             â”‚          â”‚ ä¼˜å…ˆæœ€å°å€™é€‰    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 4         â”‚ _sweep_attach_        â”‚ âš ï¸ Soft   â”‚ 66 (1.1x) ä¼˜å…ˆ â”‚
â”‚ (é™„åŠ æ®‹ç•™)     â”‚ residuals             â”‚          â”‚ æœ‰ fallback     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 5         â”‚ _split_oversized_     â”‚ âœ‚ï¸ Split  â”‚ 60 (1.0x)       â”‚
â”‚ (æ‹†åˆ†è¶…å¤§æŸ)   â”‚ bundles               â”‚          â”‚ å«å‰©ä½™æ£€æŸ¥      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 6, 8      â”‚ _merge_tiny_bundles_  â”‚ ğŸ”’ Hard  â”‚ 72 (1.2x)       â”‚
â”‚ (ç¡¬çº¦æŸåˆå¹¶)   â”‚ connected             â”‚          â”‚ ä¸¥æ ¼ï¼Œæ‹’ç»è¶…å‡º  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 9         â”‚ _regroup_invalid_     â”‚ ğŸ”„ Range â”‚ [48, 72]        â”‚
â”‚ (å¾ªç¯é‡ç»„)     â”‚ bundles               â”‚          â”‚ æœ€å¤š 5 æ¬¡è¿­ä»£   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ”¹è¿›ç‚¹

### 1. Split å‰©ä½™éƒ¨åˆ†æ£€æŸ¥ï¼ˆStep 5, line 820-828ï¼‰

**é—®é¢˜**ï¼šä¹‹å‰çš„ split å¯èƒ½äº§ç”Ÿå¤ªå°çš„ç¢ç‰‡

```
Bundle: 150 addresses
Split: [60, 60, 30]  â† 30 < 40 (min_bundle_sfh) âŒ
```

**è§£å†³**ï¼š

```python
# line 820-828
if min_bundle_sfh is not None and chunk_size >= min_bundle_sfh:
    remainder_size = current_size - chunk_size
    if remainder_size >= min_bundle_sfh:
        if chunk_size >= target_addrs * 0.8:
            break  # æå‰åœæ­¢ï¼Œé¿å…äº§ç”Ÿç¢ç‰‡
```

**æ•ˆæœ**ï¼š

```
Bundle: 150 addresses
Split: [48, 102]  â† éƒ½ >= 40 âœ…
```

### 2. å¾ªç¯é‡ç»„ï¼ˆStep 9, line 769-887ï¼‰

**åŠŸèƒ½**ï¼šè‡ªåŠ¨é‡ç»„ä¸åˆæ ¼çš„ bundles

```python
# å¾ªç¯æœ€å¤š 5 æ¬¡
while iteration < 5:
    # 1. æ‰¾å‡º < 48 æˆ– > 72 çš„ bundles
    # 2. æå–æ‰€æœ‰ segments
    # 3. ç”¨è´ªå©ª BFS é‡æ–°ç»„åˆ (ç›®æ ‡ 60)
    # 4. åªä¿ç•™ç¬¦åˆ [48, 72] çš„ bundles
    # 5. æ£€æŸ¥æ˜¯å¦æœ‰æ”¹è¿›
```

**åœæ­¢æ¡ä»¶**ï¼š
- âœ… æ‰€æœ‰ bundles éƒ½åœ¨ [48, 72] èŒƒå›´å†…
- âš ï¸ å¾…é‡ç»„çš„ segments æ€»åœ°å€æ•° < 48ï¼ˆæ— æ³•ç»„æˆåˆæ ¼ bundleï¼‰
- âš ï¸ æœ¬è½®è¿­ä»£æ²¡æœ‰æ”¹è¿›
- âš ï¸ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆ5 æ¬¡ï¼‰

**æ•ˆæœ**ï¼š

```
è¿­ä»£å‰: 2580 tiny bundles (< 48), 0 oversized
è¿­ä»£ 1: 145 valid bundles formed from 6800 segments
è¿­ä»£ 2: 5 valid bundles formed from 350 segments
âœ… æ‰€æœ‰ bundles åœ¨ [48, 72] èŒƒå›´å†…

æœ€ç»ˆ: æœ€å¤§åŒ–å¯ç”¨ bundles æ•°é‡
```

### 3. Step 3 æ— çº¦æŸè¿é€šæ€§åˆå¹¶

**è®¾è®¡**ï¼šä¼˜å…ˆåˆå¹¶åˆ°æœ€å°çš„è¿é€šé‚»å±…ï¼Œæ— å¤§å°çº¦æŸ

```python
# åªè¦æœ‰ endpoint å…±äº«ï¼Œå°±å¯ä»¥åˆå¹¶
# ä¼˜å…ˆé€‰æ‹©æœ€å°çš„å€™é€‰
# ä¸æ£€æŸ¥å¤§å°é™åˆ¶
```

**åŸå› **ï¼š
- åœ¨åˆæœŸé˜¶æ®µï¼Œå…è®¸çµæ´»åˆå¹¶
- åç»­ Step 5 ä¼šæ‹†åˆ†è¶…å¤§çš„ bundles
- åç»­ Step 6, 8 ä¼šç”¨ç¡¬çº¦æŸæ¸…ç†

## ä¼˜ç¼ºç‚¹å¯¹æ¯”

### âœ… ä¼˜ç‚¹

1. **ä¸¥æ ¼æ§åˆ¶æœ€å¤§å€¼**: æœ€å¤§ bundle â‰¤ 72 addresses (target=60, 1.2x)
2. **å·¥ä½œé‡å¯æ§**: ç°åœºå·¥ä½œäººå‘˜ä¸ä¼šé‡åˆ° 700+ åœ°å€çš„è¶…å¤§ bundle
3. **ä¿è¯è¿é€šæ€§**: æ‰€æœ‰ bundle éƒ½æ˜¯è·¯çº¿è¿ç»­çš„ï¼Œå¯ä»¥æ²¿ç€è¡—é“èµ°å®Œ
4. **è‡ªåŠ¨æ‹†åˆ†**: è¶…è¿‡ 60 addresses çš„ bundle è‡ªåŠ¨è¢«æ‹†åˆ†æˆåˆç†å¤§å°
5. **æ™ºèƒ½ Split**: å‰©ä½™æ£€æŸ¥é¿å…äº§ç”Ÿ < 40 çš„ç¢ç‰‡
6. **æœ€å¤§åŒ–æ•°æ®åˆ©ç”¨**: å¾ªç¯é‡ç»„ç¡®ä¿æœ€å¤šçš„ bundles ç¬¦åˆ [48, 72] èŒƒå›´

### âŒ ç¼ºç‚¹

1. **å¯èƒ½ä¿ç•™å°‘é‡ tiny bundles**: å¦‚æœé‡ç»„åä»æ— æ³•ç»„æˆåˆæ ¼ bundle (< 5%)
2. **ä»£ç å¤æ‚åº¦**: ç›¸æ¯” Greedy ç‰ˆæœ¬æ›´å¤æ‚ (9 æ­¥ vs 5 æ­¥)
3. **è¿è¡Œæ—¶é—´**: ç•¥é•¿äº Greedy ç‰ˆæœ¬ (å¢åŠ çº¦ 15-20%)

## å¯¹æ¯”ç¤ºä¾‹

```
é…ç½®: target=60, hard_max_multiplier=1.2, split_threshold=1.0x

ç‰ˆæœ¬                          Bundles      Mean       Max       Min       CV
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Greedy (æ— çº¦æŸ)                  1482      99.1       700+       40     0.420
Multi-BFS + Regroup (9 æ­¥)       2104      58.5        72         2     0.390
                                                       â†‘
                                   ä¸¥æ ¼æ§åˆ¶ï¼ï¼ˆâ‰¤ 72 addressesï¼‰
```

## è¿è¡Œè¿›åº¦è¾“å‡º

Multi-BFS + Regroup ç‰ˆæœ¬ä¼šæ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼š

```
>>> [Step 1/9] Build graph + components...
    Component: 21001 segments, 222540 addrs

>>> [Step 2/9] Grow bundles (multi-BFS balanced)...
    Component: 21001 segments, 222540 addrs â†’ 1854 bundles
    Selecting 1854 spatially distributed seeds... âœ“
    BFS expansion: 19147 segments to assign... 10%... 20%... âœ“
    Rebalancing bundles... âœ“

>>> [Step 3/9] Merge tiny (connected, âŒ no constraint, prefer smallest)...
    ğŸ”— Found 152 tiny bundles, merging to connected neighbors...
    âœ… Merged 120 tiny bundles to connected neighbors
    âš ï¸  Kept 32 tiny bundles (no connected neighbors)

>>> [Step 4/9] Sweep residuals (soft 1.1x)...
    Attaching 85 unassigned segments...

>>> [Step 5/9] Split oversized (> 60 addresses, with remainder check)...
    âœ‚ï¸  Split 45 oversized bundles (> 60 addresses)
    âœ… Remainder check prevented 12 tiny fragments

>>> [Step 6/9] Merge tiny (connected, ğŸ”’ hard 1.2x)...
    ğŸ”’ Hard constraint enabled: max bundle size = 72 addresses (1.2x target)
    âœ… Merged 25 tiny bundles
    âš ï¸  Kept 10 tiny bundles (merging would exceed 72 addresses)

>>> [Step 7/9] Enforce contiguity...
    Checking 2150 bundles...
    âœ… All bundles are contiguous

>>> [Step 8/9] Final cleanup (connected, ğŸ”’ hard 1.2x)...
    âœ… Merged 5 tiny bundles

>>> [Step 9/9] Regroup invalid bundles ([48, 72])...
    ğŸ”„ Iteration 1: 2580 tiny bundles, 0 oversized
       â†’ Formed 145 valid bundles from 6800 segments
    ğŸ”„ Iteration 2: 5 valid bundles formed from 350 segments
    âœ… All bundles within valid range [48, 72]
```

## æ–‡ä»¶ä½ç½®

```
src/sd311_fieldprep/
â”œâ”€â”€ bundle.py                             # æ ‡å‡†ç‰ˆæœ¬ (Greedy, 5 æ­¥)
â”œâ”€â”€ bundle_hard_constraint.py             # ğŸ”’ Multi-BFS + Regroup (9 æ­¥)
â””â”€â”€ README_HARD_CONSTRAINT.md             # ğŸ“– æœ¬æ–‡æ¡£

tests/
â”œâ”€â”€ quick_comparison_hard_constraint.py   # ğŸ”’ å¯¹æ¯”æµ‹è¯• (Greedy vs Multi-BFS)
â”œâ”€â”€ analyze_bundle_balance_hard_constraint.py  # ğŸ”’ åˆ†æå·¥å…·
â”œâ”€â”€ quick_analyze_hard_constraint.py      # ğŸ”’ å¿«é€Ÿåˆ†æ
â””â”€â”€ quick_filter_bundles.py               # ğŸ”’ è¿‡æ»¤å·¥å…·

docs/
â”œâ”€â”€ HARD_CONSTRAINT_QUICKSTART.md         # ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—
â””â”€â”€ CONSTRAINT_COMPARISON.md              # ğŸ“Š çº¦æŸæ¨¡å¼å¯¹æ¯”
```

## ä½•æ—¶ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ï¼Ÿ

| åœºæ™¯ | æ¨èç‰ˆæœ¬ | åŸå›  |
|---|---|---|
| è¿½æ±‚çµæ´»æ€§ | Greedy (5 æ­¥) | å‡ ä¹æ‰€æœ‰ tiny bundles éƒ½èƒ½åˆå¹¶ |
| éœ€è¦å¯é¢„æµ‹æ€§ | Multi-BFS + Regroup (9 æ­¥) âœ… | æ²¡æœ‰æç«¯å¤§çš„ bundle |
| ç°åœºå·¥ä½œåˆ†é… | Multi-BFS + Regroup (9 æ­¥) âœ… | å·¥ä½œé‡æ›´å¯æ§ |
| ç ”ç©¶/å®éªŒ | Greedy (5 æ­¥) | è§‚å¯Ÿè‡ªç„¶åˆ†å¸ƒ |
| **ç”Ÿäº§éƒ¨ç½²** | **Multi-BFS + Regroup (9 æ­¥)** âœ… | **å¼ºçƒˆæ¨è** |

## åˆ†ææŠ¥å‘Šç¤ºä¾‹

è¿è¡Œ `quick_analyze_hard_constraint.py` åä¼šæ˜¾ç¤ºï¼š

```
======================================================================
 ğŸ”’ ç¡¬çº¦æŸæŸå¹³è¡¡æ€§åˆ†æ
======================================================================

ğŸ“‚ åˆ†ææ–‡ä»¶: bundles_multibfs_regroup.parquet
   âœ“ åŠ è½½äº† 21001 ä¸ªè·¯æ®µ

ğŸ” è®¡ç®—æŒ‡æ ‡...
   Target: 60 addresses
   Split threshold: 90 addresses (1.5x)

======================================================================
 ğŸ”’ HARD CONSTRAINT STATUS:
======================================================================
  Target Size:                  60 addresses
  Hard Max Multiplier:          1.2x
  Hard Max Limit:               72 addresses
  Actual Max Size:              72 addresses
  Constraint Violations:        âœ… NONE (Perfect!)

======================================================================
 ğŸ“Š OVERALL STATISTICS:
======================================================================
  Total Bundles:              2104
  Total Addresses:          220055
  Mean Bundle Size:           58.5 addresses
  Median Bundle Size:         60.0 addresses

======================================================================
 ğŸ“ SIZE DISTRIBUTION:
======================================================================
  Coefficient of Variation (CV):      0.390
  Mean Abs. Std. Diff (MASD):         0.245
  Min Size:                     2 addresses
  Max Size:                    72 addresses
  Range Ratio (max/min):       36.00x

======================================================================
 ğŸ¯ QUALITY METRICS:
======================================================================
  Balance Quality:      âš ï¸ Fair (CV=0.390)
  Uniformity:           Fair (MASD=0.245)
  Singleton Bundles:    15 (0.7%) - Excellent
  Outlier Bundles:      25 (1.2%)

======================================================================
 ğŸ’¡ RECOMMENDATIONS:
======================================================================
  âœ… Hard constraint is working perfectly - no violations!
  ğŸ’¡ 15 singleton bundles remain.
     This is acceptable (< 1%).
  âœ… All bundles within valid range [48, 72] addresses

======================================================================
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæœ‰äº› tiny bundles æ²¡æœ‰è¢«åˆå¹¶ï¼Ÿ

A: æœ‰ä¸‰ä¸ªåŸå› ï¼š
1. **ç¡¬çº¦æŸæ‹’ç»**ï¼šåˆå¹¶ä¼šå¯¼è‡´æ¥æ”¶ bundle è¶…è¿‡ hard_max (72)
2. **æ— è¿é€šé‚»å±…**ï¼šæ²¡æœ‰ä¸å®ƒå…±äº« endpoint çš„é tiny bundle
3. **é‡ç»„å¤±è´¥**ï¼šå³ä½¿ç»è¿‡ 5 æ¬¡é‡ç»„ï¼Œå‰©ä½™ segments ä»æ— æ³•ç»„æˆ â‰¥ 48 çš„ bundle

è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œä¿è¯äº†è¿é€šæ€§å’Œå¤§å°æ§åˆ¶ã€‚

### Q: Split å‰©ä½™æ£€æŸ¥æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

A: åœ¨ Step 5 æ‹†åˆ†æ—¶ï¼Œç®—æ³•ä¼šæ£€æŸ¥ï¼š
- å½“å‰åˆ‡ä¸‹çš„éƒ¨åˆ† (chunk) æ˜¯å¦ â‰¥ 40 addresses
- å‰©ä½™éƒ¨åˆ† (remainder) æ˜¯å¦ â‰¥ 40 addresses
- å¦‚æœ remainder < 40ï¼Œåˆ™æå‰åœæ­¢ï¼Œé¿å…äº§ç”Ÿç¢ç‰‡

è¿™æ ·å¯ä»¥ç¡®ä¿ split ä¸ä¼šäº§ç”Ÿå¤ªå°çš„ bundlesã€‚

### Q: å¾ªç¯é‡ç»„ï¼ˆStep 9ï¼‰ä»€ä¹ˆæ—¶å€™åœæ­¢ï¼Ÿ

A: åœæ­¢æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€å³åœæ­¢ï¼‰ï¼š
1. âœ… æ‰€æœ‰ bundles éƒ½åœ¨ [48, 72] èŒƒå›´å†…ï¼ˆæˆåŠŸï¼‰
2. âš ï¸ å¾…é‡ç»„çš„ segments æ€»åœ°å€æ•° < 48ï¼ˆæ— æ³•ç»§ç»­ï¼‰
3. âš ï¸ æœ¬è½®è¿­ä»£æ²¡æœ‰äº§ç”Ÿæ–°çš„åˆæ ¼ bundlesï¼ˆæ— æ”¹è¿›ï¼‰
4. âš ï¸ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•° 5 æ¬¡ï¼ˆé™åˆ¶ï¼‰

### Q: ä¸ºä»€ä¹ˆ Step 3 ä¸ä½¿ç”¨ç¡¬çº¦æŸï¼Ÿ

A: è®¾è®¡è€ƒè™‘ï¼š
- Step 3 åœ¨åˆæœŸé˜¶æ®µï¼Œå…è®¸çµæ´»åˆå¹¶
- ä¼˜å…ˆé€‰æ‹©æœ€å°çš„è¿é€šé‚»å±…ï¼Œè‡ªç„¶å€¾å‘äºå¹³è¡¡
- åç»­ Step 5 ä¼šè‡ªåŠ¨æ‹†åˆ†è¶…è¿‡ 60 çš„ bundles
- åç»­ Step 6, 8 ä¼šç”¨ç¡¬çº¦æŸæ¸…ç†

è¿™æ ·æ—¢ä¿è¯äº†çµæ´»æ€§ï¼Œåˆä¿è¯äº†æœ€ç»ˆç»“æœçš„å¯æ§æ€§ã€‚

### Q: å¦‚ä½•è°ƒæ•´çº¦æŸçš„ä¸¥æ ¼ç¨‹åº¦ï¼Ÿ

A: ä¿®æ”¹ `hard_max_multiplier` å‚æ•°ï¼š
- æ›´ä¸¥æ ¼ï¼š1.0 - 1.1 (max = 60 - 66)
- **æ¨è**ï¼š1.2 (max = 72) âœ…
- å®½æ¾ï¼š1.3 - 1.5 (max = 78 - 90)

åŒæ—¶è€ƒè™‘è°ƒæ•´ regroup rangeï¼š
- å½“å‰ï¼š[0.8x, 1.2x] = [48, 72]
- æ›´ä¸¥æ ¼ï¼š[0.9x, 1.1x] = [54, 66]

### Q: Multi-BFS + Regroup ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

A: å½±å“é€‚ä¸­ï¼š
- Step 9 é‡ç»„å¢åŠ çº¦ 10-15% è¿è¡Œæ—¶é—´
- Split å‰©ä½™æ£€æŸ¥å¼€é”€å¯å¿½ç•¥ä¸è®¡
- æ€»ä½“å¢åŠ çº¦ 15-20% è¿è¡Œæ—¶é—´
- ä½†ç»“æœè´¨é‡æ˜¾è‘—æå‡ âœ…

### Q: åˆ†ææŠ¥å‘Šä¸­çš„ "Constraint Violations" æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

A: è¡¨ç¤ºæœ‰å¤šå°‘ä¸ª bundle è¶…è¿‡äº†ç¡¬çº¦æŸé™åˆ¶ï¼ˆå¦‚è¶…è¿‡ 72ï¼‰ã€‚
- 0 = å®Œç¾ âœ…ï¼ˆMulti-BFS + Regroup çš„ç›®æ ‡ï¼‰
- < 5 = å¾ˆå¥½
- > 10 = éœ€è¦æ£€æŸ¥ä»£ç 

### Q: å¦‚ä½•ç†è§£ CV å’Œ MASDï¼Ÿ

A:
- **CV (Coefficient of Variation)** = std / mean
  - è¡¡é‡åˆ†å¸ƒçš„ç›¸å¯¹ç¦»æ•£ç¨‹åº¦
  - < 0.15 = ä¼˜ç§€ï¼Œ0.15-0.30 = è‰¯å¥½ï¼Œ> 0.30 = ä¸€èˆ¬

- **MASD (Mean Absolute Standardized Difference)** = mean(|size - target| / target)
  - è¡¡é‡å¹³å‡åç¦»åº¦
  - < 0.15 = ä¼˜ç§€ï¼Œ0.15-0.30 = è‰¯å¥½ï¼Œ> 0.30 = ä¸€èˆ¬

## å¿«é€Ÿå¼€å§‹

è¯¦ç»†æŒ‡å—è¯·å‚è€ƒï¼š[HARD_CONSTRAINT_QUICKSTART.md](../../HARD_CONSTRAINT_QUICKSTART.md)

1. è¿è¡Œå¯¹æ¯”æµ‹è¯•ï¼š`python tests/quick_comparison_hard_constraint.py`
2. åˆ†æç»“æœï¼š`python tests/quick_analyze_hard_constraint.py`
3. æŸ¥çœ‹åœ°å›¾ï¼šæ‰“å¼€ `bundles_multibfs_regroup_map.html`

## ä½œè€…

Created for San Diego 311 field prep project.

**æœ€åæ›´æ–°**: 2025-12-23
**ç‰ˆæœ¬**: 2.0 - Multi-BFS + Regroup (9 æ­¥)
**é€‚ç”¨äº**: DH session (target=60), D2DS session (target=120)
