name: Daily Assignment Emails

on:
  schedule:
    # Run every Saturday at 6:00 AM Pacific Time (14:00 UTC in standard time)
    # Note: GitHub Actions uses UTC time
    # Saturday = 6 in cron (0=Sunday, 6=Saturday)
    # Jan-Feb: 6 AM PST = 14:00 UTC
    # Mar-Aug (during DST): 6 AM PDT = 13:00 UTC (need to update cron in March)
    - cron: '0 14 * * 6'

  workflow_dispatch:
    # Allow manual triggering for testing
    inputs:
      date:
        description: 'Date to send emails for (YYYY-MM-DD). Leave empty for today.'
        required: false
        type: string
      dry_run:
        description: 'Dry run (print emails without sending)'
        required: false
        type: boolean
        default: false
      test_mode:
        description: 'Test mode (add 【fake test】 to subject)'
        required: false
        type: boolean
        default: false

jobs:
  send-emails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas requests google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Create OAuth credentials file
        run: |
          echo '${{ secrets.GMAIL_OAUTH_CREDENTIALS }}' > client_secret.json

      - name: Create OAuth token file
        run: |
          echo '${{ secrets.GMAIL_OAUTH_TOKEN }}' > token.json

      - name: Check date range
        id: check_date
        run: |
          # Only send emails from Jan 10, 2026 to Aug 8, 2026
          if [ -n "${{ inputs.date }}" ]; then
            TODAY="${{ inputs.date }}"
          else
            TODAY=$(date -u +%Y-%m-%d)
          fi

          START_DATE="2026-01-10"
          END_DATE="2026-08-08"

          if [[ "$TODAY" < "$START_DATE" ]] || [[ "$TODAY" > "$END_DATE" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Date $TODAY is outside the valid range ($START_DATE to $END_DATE). Skipping email sending."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Date $TODAY is within valid range. Proceeding with email sending."
            echo "target_date=$TODAY" >> $GITHUB_OUTPUT
          fi

      - name: Download starts.csv from Google Drive
        if: steps.check_date.outputs.skip != 'true'
        env:
          GOOGLE_DRIVE_OAUTH_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_OAUTH_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          TARGET_DATE="${{ steps.check_date.outputs.target_date }}"
          OUTPUT_DIR="outputs/incoming/daily"

          echo "Downloading starts.csv for $TARGET_DATE from Google Drive..."
          mkdir -p "$OUTPUT_DIR"

          python scripts/download_from_drive.py \
            "$GOOGLE_DRIVE_FOLDER_ID" \
            "$TARGET_DATE" \
            "$OUTPUT_DIR/$TARGET_DATE" \
            --oauth-credentials "$GOOGLE_DRIVE_OAUTH_CREDENTIALS"

          echo "✓ Downloaded files:"
          ls -lh "$OUTPUT_DIR/$TARGET_DATE"

      - name: Send assignment emails
        if: steps.check_date.outputs.skip != 'true'
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            DATE_ARG="--date ${{ inputs.date }}"
          else
            DATE_ARG=""
          fi

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_ARG="--dry-run"
          else
            DRY_RUN_ARG=""
          fi

          if [ "${{ inputs.test_mode }}" = "true" ]; then
            TEST_MODE_ARG="--test-mode"
          else
            TEST_MODE_ARG=""
          fi

          # Use the downloaded files (relative path works in GitHub Actions)
          python send_assignments.py $DATE_ARG $DRY_RUN_ARG $TEST_MODE_ARG --base "outputs/incoming/daily"

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: email-logs
          path: |
            *.log
            *.txt
          retention-days: 7
