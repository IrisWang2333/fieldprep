name: Weekly Plan and Emit

on:
  schedule:
    # Runs every Friday at 10:00 PM Pacific Time
    # PST (Winter): Friday 10:00 PM = Saturday 6:00 AM UTC
    # PDT (Summer): Friday 10:00 PM = Saturday 5:00 AM UTC
    # Using 6:00 AM UTC for PST; adjust to 5:00 during PDT if needed
    - cron: '0 6 * * 6'  # Every Saturday at 6:00 AM UTC

  workflow_dispatch:  # Allow manual triggering for testing

env:
  PYTHON_VERSION: '3.11'

jobs:
  plan-and-emit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify geospatial data
        run: |
          echo "Verifying geospatial data files..."
          ls -lh data/raw/DataSD/
          echo "✓ Geospatial data ready (included in repository)"

      - name: Download latest notification activities
        run: |
          echo "Downloading latest pothole data..."
          python -c "
          from utils.data_fetcher import fetch_latest_notification_activities
          activities = fetch_latest_notification_activities(use_local=False, download_if_missing=True)
          print(f'Downloaded {len(activities)} pothole records')
          "

      - name: Calculate this Saturday date
        id: date
        run: |
          # Calculate this coming Saturday (start of this week)
          # This workflow runs Friday 10pm PST = Saturday ~6am UTC
          # We want THIS Saturday, not next Saturday
          THIS_SATURDAY=$(python -c "
          from datetime import datetime, timedelta
          today = datetime.now()
          # If today is Saturday (workflow runs Sat 6am UTC), use today
          # If today is Friday (edge case), use tomorrow
          if today.weekday() == 5:  # Saturday
              this_saturday = today
          elif today.weekday() == 4:  # Friday
              this_saturday = today + timedelta(days=1)
          else:
              # Fallback: calculate days to next Saturday
              days_until_saturday = (5 - today.weekday()) % 7
              if days_until_saturday == 0:
                  days_until_saturday = 7
              this_saturday = today + timedelta(days=days_until_saturday)
          print(this_saturday.strftime('%Y-%m-%d'))
          ")
          echo "next_saturday=$THIS_SATURDAY" >> $GITHUB_OUTPUT
          echo "This week starts: $THIS_SATURDAY"

      - name: Run plan.py
        id: plan
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          echo "Generating plan for $DATE..."

          # Run plan.py with next Saturday's date
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from sd311_fieldprep.plan import run_plan

          date = '$DATE'
          print(f'Running plan for {date}...')

          # Pilot phase (until 2026-01-10): Use Week 1 design (DH only, no D2DS)
          # Week 1 (2026-01-10): First official week, use is_week_1=True
          # Week 2+ (after 2026-01-10): Use is_week_1=False (DH + D2DS)
          plan_csv = run_plan(
              date=date,
              interviewers=('A', 'B', 'C', 'D', 'E', 'F'),
              tasks=('DH', 'D2DS'),
              list_code=30,
              seed=42,
              bundle_file='outputs/bundles/DH/bundles_multibfs_regroup_filtered.parquet',
              is_week_1=True  # Pilot phase - use Week 1 design (24 DH, no D2DS)
          )
          print(f'Plan created: {plan_csv}')
          " | tee plan_output.log

          # Extract plan CSV path from output
          PLAN_CSV=$(grep "Plan created:" plan_output.log | sed 's/Plan created: //')
          echo "plan_csv=$PLAN_CSV" >> $GITHUB_OUTPUT
          echo "Plan CSV: $PLAN_CSV"

      - name: Run emit.py
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          PLAN_CSV="${{ steps.plan.outputs.plan_csv }}"

          echo "Running emit for $DATE..."

          python -c "
          import sys
          sys.path.insert(0, 'src')
          from sd311_fieldprep.emit import run_emit

          run_emit(
              date='$DATE',
              plan_csv='$PLAN_CSV',
              bundle_file='outputs/bundles/DH/bundles_multibfs_regroup_filtered.parquet'
          )
          print('Emit completed!')
          "

      - name: Prepare upload directory
        id: prepare
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          UPLOAD_DIR="outputs/incoming/daily/$DATE"

          echo "upload_dir=$UPLOAD_DIR" >> $GITHUB_OUTPUT

          # List generated files
          echo "Generated files:"
          ls -lh "$UPLOAD_DIR"

      - name: Upload to Google Drive
        env:
          GOOGLE_DRIVE_OAUTH_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_OAUTH_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          UPLOAD_DIR="outputs/incoming/daily/$DATE"

          echo "Uploading to Google Drive..."
          python scripts/upload_to_drive.py \
            "$UPLOAD_DIR" \
            "$GOOGLE_DRIVE_FOLDER_ID" \
            --oauth-credentials "$GOOGLE_DRIVE_OAUTH_CREDENTIALS"

      - name: Send success notification
        if: success()
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          echo "✅ Weekly plan and emit completed successfully for $DATE"
          echo "Files uploaded to Google Drive"

      - name: Send failure notification
        if: failure()
        run: |
          DATE="${{ steps.date.outputs.next_saturday }}"
          echo "❌ Weekly plan and emit failed for $DATE"
          echo "Check the logs for details"

      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-emit-logs-${{ steps.date.outputs.next_saturday }}
          path: |
            plan_output.log
            outputs/incoming/daily/${{ steps.date.outputs.next_saturday }}/*.csv
          retention-days: 30
